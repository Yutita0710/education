
<template>
  <div
    v-if="showModal"
    class="fixed inset-0 z-[999] flex items-center justify-center bg-black/50 text-gray-700"
  >
    <div
      class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-4xl relative overflow-y-auto max-h-[90vh]"
      @click.stop
    >
      <!-- Close button -->
      <button
        @click="closeModal"
        class="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
        aria-label="Close modal"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="size-8 mr-2"
        >
          <path
            fill-rule="evenodd"
            d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z"
            clip-rule="evenodd"
          />
        </svg>
      </button>
      <!-- Header -->
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        </h1>
      </div>
      <!-- <div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex items-start">
          <div class="text-blue-500 mr-3 mt-0.5">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="size-6 mr-2"
            >
              <path
                fill-rule="evenodd"
                d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <div class="font-bold text-blue-800">
            <p class="mb-1">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</p>
            <ul class="list-disc list-inside space-y-1 text-blue-700">
              <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ * (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</li>
              <li>‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. (‡πÄ‡∏ä‡πà‡∏ô 2568)</li>
              <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>
            </ul>
          </div>
        </div>
      </div> -->
      <!-- Form Card -->
      <form @submit.prevent="saveCurriculum" class="space-y-4">
        <div class="mb-4 relative">
          <label class="block font-bold mb-1">
            ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô <span class="text-red-500">*</span>
          </label>
          <v-select
            class="font-[15px]"
            v-model="selectedCollege"
            :options="colleges"
            label="name"
            :reduce="(college) => college.id"
            placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤..."
            required
          />
        </div>
        <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ -->
        <div>
          <label class="block font-bold mb-1">
            ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ <span class="text-red-500">*</span>
          </label>

          <v-select
            class="font-[15px]"
            v-model="selectedCurriculumId"
            :options="curriculumOptions"
            label="name"
            :reduce="(opt) => opt.id"
            :disabled="isLoading || !curriculumOptions.length"
            placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£..."
            required
          />
        </div>
        <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ -->

        <div class="grid grid-cols-2 gap-4 items-end w-full">
          <!-- ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ -->
          <div>
            <label class="block font-bold mb-1">
              ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ <span class="text-red-500">*</span>
            </label>
            <input
              v-model="form.description"
              type="text"
              required
              class="w-full border px-4 py-2 rounded-xl"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"
            />
          </div>

          <!-- ‡∏û.‡∏®. -->
          <div class="flex flex-row items-center gap-2 w-full">
            <label class="whitespace-nowrap">‡∏û.‡∏®.</label>
            <input
              type="text"
              required
              class="flex-1 border px-4 py-2 rounded-xl items-end"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å ‡∏û.‡∏®."
            />
          </div>
        </div>

        <!-- ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ -->
        <div class="mb-4 relative">
          <label class="block font-bold mb-1">
            ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span class="text-red-500">*</span>
          </label>
          <Listbox
            v-model="selectedDegree"
            as="div"
            class="relative w-full rounded-lg border px-2 py-[0.15rem]"
          >
            <ListboxButton
              class="relative w-full inline-flex items-center justify-between px-3 py-2"
            >
              <span class="truncate">
                {{ selectedDegree?.name || "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤" }}
              </span>
              <ChevronUpDownIcon
                class="w-5 h-5 text-gray-500"
                aria-hidden="true"
              />
            </ListboxButton>

            <ListboxOptions
              class="absolute z-20 mt-2 max-h-60 w-full md:w-[14rem] overflow-auto rounded-xl bg-white py-1 text-sm shadow-lg ring-1 ring-black/5 left-0"
            >
              <ListboxOption
                v-for="degree in filteredDegrees"
                :key="degree.id"
                :value="degree"
                class="relative cursor-default select-none py-2 pl-10 pr-4 hover:bg-blue-50"
              >
                <span class="block truncate">{{ degree.name }}</span>
                <span
                  v-if="selectedDegree?.id === degree.id"
                  class="absolute inset-y-0 left-3 flex items-center text-blue-600"
                >
                  <CheckIcon class="w-5 h-5" aria-hidden="true" />
                </span>
              </ListboxOption>
            </ListboxOptions>
          </Listbox>
        </div>
        <!-- ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö -->
        <div>
          <label class="block font-bold mb-1"
            >‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <span class="text-red-500">*</span></label
          >
          <ul
            class="items-center w-full text-sm font-medium text-gray-900 bg-white sm:flex"
          >
            <li class="w-full">
              <div class="flex items-center ps-3">
                <input
                  id="vue-checkbox-list"
                  type="checkbox"
                  value=""
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500"
                />
                <label
                  for="vue-checkbox-list"
                  class="w-full py-3 ms-2 text-sm font-medium text-gray-900"
                  >‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label
                >
              </div>
            </li>
            <li class="w-full">
              <div class="flex items-center ps-3">
                <input
                  id="react-checkbox-list"
                  type="checkbox"
                  value=""
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500"
                />
                <label
                  for="react-checkbox-list"
                  class="w-full py-3 ms-2 text-sm font-medium text-gray-900"
                  >‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≤‡∏°‡∏±‡∏ç</label
                >
              </div>
            </li>
            <li class="w-full">
              <div class="flex items-center ps-3">
                <input
                  id="angular-checkbox-list"
                  type="checkbox"
                  value=""
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500"
                />
                <label
                  for="angular-checkbox-list"
                  class="w-full py-3 ms-2 text-sm font-medium text-gray-900"
                  >‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ß‡∏¥‡∏™‡∏≤‡∏°‡∏±‡∏ç</label
                >
              </div>
            </li>
            <li class="w-full">
              <div class="flex items-center ps-3">
                <input
                  id="laravel-checkbox-list"
                  type="checkbox"
                  value=""
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500"
                />
                <label
                  for="laravel-checkbox-list"
                  class="w-full py-3 ms-2 text-sm font-medium text-gray-900"
                  >‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏°‡∏ó‡∏ö</label
                >
              </div>
            </li>
          </ul>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
        <div>
          <label class="block font-bold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea
            v-model="form.remark"
            rows="2"
            class="w-full border px-4 py-2 rounded-xl resize-none"
          ></textarea>
        </div>
        <!-- 2 Column Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <!-- ‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
          <div>
            <label class="block font-bold mb-1">
              ‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏û.‡∏®.) <span class="text-red-500">*</span>
            </label>
            <input
              v-model="form.start_year"
              type="text"
              @blur="limitYear('start_year')"
              class="w-full border px-4 py-2 rounded-xl"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568"
              required
            />
          </div>

          <!-- ‡∏õ‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î -->
          <div>
            <label class="block font-bold mb-1">
              ‡∏õ‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏û.‡∏®.) <span class="text-red-500">*</span>
            </label>
            <input
              v-model="form.end_year"
              type="text"
              @blur="limitYear('end_year')"
              class="w-full border px-4 py-2 rounded-xl"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 2570"
              required
              disabled
            />
          </div>

          <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
          <div>
            <label for="ispublic" class="block mb-2 font-medium text-gray-900"
              >‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</label
            >
            <Listbox
              v-model="selectedIspublic"
              as="div"
              class="relative w-full rounded-lg border px-2 py-[0.15rem]"
            >
              <ListboxButton
                class="relative w-full inline-flex items-center justify-between px-3 py-2"
              >
                <span class="truncate">{{
                  selectedIspublic?.name || "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà"
                }}</span>
                <ChevronUpDownIcon
                  class="w-5 h-5 text-gray-500"
                  aria-hidden="true"
                />
              </ListboxButton>

              <ListboxOptions
                class="absolute z-20 mt-2 max-h-60 w-full md:w-[14rem] overflow-auto rounded-xl bg-white py-1 text-sm shadow-lg ring-1 ring-black/5 left-0"
              >
                <ListboxOption
                  v-for="ispublic in ispublicOptions"
                  :key="ispublic.id"
                  :value="ispublic"
                  class="relative cursor-default select-none py-2 pl-10 pr-4 hover:bg-blue-50"
                >
                  <span class="block truncate">{{ ispublic.name }}</span>
                  <span
                    v-if="selectedIspublic?.id === ispublic.id"
                    class="absolute inset-y-0 left-3 flex items-center text-blue-600"
                  >
                    <CheckIcon class="w-5 h-5" aria-hidden="true" />
                  </span>
                </ListboxOption>
              </ListboxOptions>
            </Listbox>
          </div>
          <div>
            <label for="status" class="block mb-2 font-medium text-gray-900"
              >‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label
            >
            <Listbox
              v-model="selectedStatus"
              as="div"
              class="relative w-full rounded-lg border px-2 py-[0.15rem]"
            >
              <ListboxButton
                class="relative w-full inline-flex items-center justify-between px-3 py-2"
              >
                <span class="truncate">{{
                  selectedStatus?.name || "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
                }}</span>
                <ChevronUpDownIcon
                  class="w-5 h-5 text-gray-500"
                  aria-hidden="true"
                />
              </ListboxButton>

              <ListboxOptions
                class="absolute z-20 mt-2 max-h-60 w-full md:w-[14rem] overflow-auto rounded-xl bg-white py-1 text-sm shadow-lg ring-1 ring-black/5 left-0"
              >
                <ListboxOption
                  v-for="status in statusOptions"
                  :key="status.id"
                  :value="status"
                  class="relative cursor-default select-none py-2 pl-10 pr-4 hover:bg-blue-50"
                >
                  <span class="block truncate">{{ status.name }}</span>
                  <span
                    v-if="selectedStatus?.id === status.id"
                    class="absolute inset-y-0 left-3 flex items-center text-blue-600"
                  >
                    <CheckIcon class="w-5 h-5" aria-hidden="true" />
                  </span>
                </ListboxOption>
              </ListboxOptions>
            </Listbox>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-center gap-3 pt-6 border-t border-gray-200">
          <button
            type="submit"
            :disabled="isLoading"
            class="bg-[#0085DB] hover:bg-[#0085DB] text-white px-4 py-2 rounded-full font-medium shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center"
          >
            <span v-if="!isLoading" class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="size-6 mr-2"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.478 5.559A1.5 1.5 0 0 1 6.912 4.5H9A.75.75 0 0 0 9 3H6.912a3 3 0 0 0-2.868 2.118l-2.411 7.838a3 3 0 0 0-.133.882V18a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3v-4.162c0-.299-.045-.596-.133-.882l-2.412-7.838A3 3 0 0 0 17.088 3H15a.75.75 0 0 0 0 1.5h2.088a1.5 1.5 0 0 1 1.434 1.059l2.213 7.191H17.89a3 3 0 0 0-2.684 1.658l-.256.513a1.5 1.5 0 0 1-1.342.829h-3.218a1.5 1.5 0 0 1-1.342-.83l-.256-.512a3 3 0 0 0-2.684-1.658H3.265l2.213-7.191Z"
                  clip-rule="evenodd"
                />
                <path
                  fill-rule="evenodd"
                  d="M12 2.25a.75.75 0 0 1 .75.75v6.44l1.72-1.72a.75.75 0 1 1 1.06 1.06l-3 3a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 0 1 1.06-1.06l1.72 1.72V3a.75.75 0 0 1 .75-.75Z"
                  clip-rule="evenodd"
                />
              </svg>

              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </span>
            <span v-else class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="size-6 mr-2"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z"
                  clip-rule="evenodd"
                />
              </svg>

              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            </span>
          </button>
          <button
            type="button"
            @click="closeModal"
            class="bg-[#F95668] hover:bg-[#F95668]/80 text-white px-4 py-2 rounded-full font-medium shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 flex items-center"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </form>
    </div>
  </div>
</template>
<script setup>
import { reactive, ref, watch } from "vue";
import {
  addEducation,
  getCollegesPaginated,
  getDegrees,
  getEducationPaginated,
} from "@/services/apiService";
import Swal from "sweetalert2";
import vSelect from "vue-select";
import "vue-select/dist/vue-select.css";
import {
  Listbox,
  ListboxButton,
  ListboxOption,
  ListboxOptions,
} from "@headlessui/vue";
import { CheckIcon, ChevronUpDownIcon } from "@heroicons/vue/20/solid";
const selectedCollege = ref(null);
const selectedDegree = ref(null);
// ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô id ‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£)
const selectedCurriculumId = ref(null);

// ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô v-select (‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£)
const curriculumOptions = ref([]);

const props = defineProps({
  showModal: Boolean,
  closeModal: Function,
});

const emit = defineEmits(["close"]);
const statusOptions = [
  { id: 1, name: "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" },
  { id: 0, name: "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" },
];
const ispublicOptions = [
  { id: 1, value: true, name: "‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà" },
  { id: 0, value: false, name: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà" },
];

const selectedStatus = ref(statusOptions[0]);
const selectedIspublic = ref(ispublicOptions[0]);
const colleges = ref([]);
const isLoading = ref(false);
const search = ref("");
const degrees = ref([]); // ‡∏à‡∏≤‡∏Å API
const filteredDegrees = ref([]);
const form = reactive({
  name: "",
  description: "",
  degree_id: "",
  start_year: "",
  end_year: "",
  college_id: "",
  active: 1,
});
console.log("form", form);
function onDegreeChange(event) {
  const selectedValue = event.target.value;
  const numberValue = selectedValue ? Number(selectedValue) : null;

  form.degree_id = numberValue;

  console.log("üëâ selectedValue:", selectedValue); // "5" (string)
  console.log("üëâ numberValue:", numberValue); // 5 (number)
  console.log("üëâ form.degree_id:", form.degree_id); // 5
}

function clearForm() {
  form.name = "";
  form.description = "";
  form.degree_id = null; // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï v-select
  form.college_id = null; // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï v-select
  form.start_year = "";
  form.end_year = "";
  form.active = 1;
  form.remark = "";
  selectedCollege.value = null;
  selectedDegree.value = null;
}

function limitYear(field) {
  const value = form[field]?.toString();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 4 ‡∏´‡∏•‡∏±‡∏Å
  if (!/^\d{4}$/.test(value)) {
    Swal.fire({
      title: "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
      text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å",
      icon: "warning",
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
    });

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏≠‡∏≠‡∏Å
    form[field] = "";
  }
}
watch(selectedCollege, (val) => {
  form.college_id = val || "";
});
watch(selectedDegree, (val) => {
  form.degree_id = val || "";
});
// Watch start_year ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏ß‡∏Å 5 ‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
watch(
  () => form.start_year,
  (newStart) => {
    const start = parseInt(newStart);
    if (!isNaN(start)) {
      // ‡∏ö‡∏ß‡∏Å 5 ‡∏õ‡∏µ‡πÄ‡∏™‡∏°‡∏≠
      form.end_year = start + 4;
    } else {
      form.end_year = "";
    }
  }
);

// Watch end_year ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
watch(
  () => form.end_year,
  (newEndYear) => {
    const start = parseInt(form.start_year);
    const end = parseInt(newEndYear);

    if (!isNaN(start) && !isNaN(end)) {
      if (end < start) {
        form.end_year = start; // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö start_year
      }
    }
  }
);

watch(
  () => props.showModal,
  (newVal) => {
    if (newVal) {
      fetchDegrees();
      fetchColleges();
      fetchCurriculum(1, {});

      if (!props.curriculum) clearForm(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡∏°‡πà
    }
  }
);

async function saveCurriculum() {
  console.log("form", form);
  if (!form.name.trim()) {
    Swal.fire({ icon: "warning", title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£" });
    return;
  }

  if (
    !form.degree_id ||
    !form.college_id ||
    !form.start_year ||
    !form.end_year
  ) {
    Swal.fire({ icon: "warning", title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô" });
    return;
  }

  const start = parseInt(form.start_year);
  const end = parseInt(form.end_year);
  const diff = end - start;

  if (start >= end) {
    Swal.fire({ icon: "warning", title: "‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î" });
    return;
  }

  if (diff > 10) {
    const confirm = await Swal.fire({
      icon: "question",
      title: `‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏µ ${diff} ‡∏õ‡∏µ ‡∏î‡∏π‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ`,
      text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
      showCancelButton: true,
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
      cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    });
    if (!confirm.isConfirmed) return;
  }

  isLoading.value = true;

  try {
    const submitData = {
      ...form,
      degree_id: parseInt(form.degree_id),
      start_year: form.start_year.toString(),
      end_year: form.end_year.toString(),
      college_id: parseInt(form.college_id),
      active: parseInt(form.active),
    };

    await addEducation(submitData);

    await Swal.fire({
      icon: "success",
      title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
      text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
      timer: 1500,
      showConfirmButton: false,
      timerProgressBar: true,
    });
    emit("refresh-data"); // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÉ‡∏´‡πâ parent ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
    props.closeModal();
  } catch (err) {
    console.error(err);

    Swal.fire({
      icon: "error",
      title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
      text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
      confirmButtonColor: "#EF4444",
      timerProgressBar: true,
    });
  } finally {
    isLoading.value = false;
  }
}

// AddCurriculumModal.vue (‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ)
async function fetchCurriculum(page = 1, filters = {}) {
  try {
    // ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏ï‡∏¥‡∏° sort ‡πÄ‡∏õ‡πá‡∏ô 'id'
    // ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà sort ‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô "0"/"1" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const res = await getEducationPaginated(page, undefined, {
      ...filters,
      // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: sort ‡πÄ‡∏õ‡πá‡∏ô index (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      // sort: "0",           // <= ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ API ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡∏ä‡∏ô‡∏µ
      // order: "ASC",
    });
console.log("Curriculums", res);
    const list = Array.isArray(res?.data?.data) ? res.data.data : [];
    curriculumOptions.value = list.map((c) => ({ id: c.id, name: c.name }));
  } catch (err) {
    console.error("‚ùå API error payload:", err?.response?.data || err);
  }
}

// Fetch degrees
async function fetchDegrees() {
  try {
    const res = await getDegrees();
    console.log("Degrees", res);
    degrees.value = res.data?.data || [];
    filteredDegrees.value = [...degrees.value];
  } catch {
    Swal.fire({
      icon: "error",
      title: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
      text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
      confirmButtonColor: "#EF4444",
    });
  }
}

async function fetchColleges() {
  try {
    const params = {
      sort: "id",
      order: "ASC",
      search: search.value.trim(),
    };

    const res = await getCollegesPaginated(params);
    console.log(res);
    colleges.value = res.data?.data || [];
  } catch (err) {
    console.error("Error fetching colleges:", err);

    Swal.fire({
      icon: "error",
      title: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
      text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
      confirmButtonColor: "#EF4444",
      timerProgressBar: true,
    });
  }
}
</script>
